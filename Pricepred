import os
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.metrics import mean_squared_error, r2_score

# Create output directory
output_dir = "house_outputs"
os.makedirs(output_dir, exist_ok=True)

# Load and clean data
df = pd.read_csv("house.csv")
df = df.dropna()

# Features and target
features = [
    "Avg Area Income",
    "Avg Area House Age",
    "Avg Area Number of Rooms",
    "Avg Area Number of Bedrooms",
    "Area Population"
]
target = "Price"

X = df[features]
y = df[target]

# Split dataset
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

# Train model
model = LinearRegression()
model.fit(X_train, y_train)

# Predict
y_pred = model.predict(X_test)

# Metrics
mse = mean_squared_error(y_test, y_pred)
r2 = r2_score(y_test, y_pred)

with open(f"{output_dir}/metrics.txt", "w") as f:
    f.write(f"Linear Regression Metrics:\n")
    f.write(f"MSE: {mse}\n")
    f.write(f"R2 Score: {r2}\n")

# --------- PLOTS ---------

# 1. Actual vs Predicted
plt.figure()
plt.scatter(y_test, y_pred, alpha=0.6)
plt.xlabel("Actual Price")
plt.ylabel("Predicted Price")
plt.title("Actual vs Predicted Price")
plt.savefig(f"{output_dir}/actual_vs_predicted.png")
plt.close()

# 2. Residuals
residuals = y_test - y_pred
plt.figure()
plt.scatter(y_pred, residuals, alpha=0.6)
plt.xlabel("Predicted Price")
plt.ylabel("Residuals")
plt.title("Residual Plot")
plt.axhline(0, color='red', linestyle='--')
plt.savefig(f"{output_dir}/residuals.png")
plt.close()

# 3. Scatter matrix
pd.plotting.scatter_matrix(df[features + [target]], figsize=(12, 12))
plt.savefig(f"{output_dir}/scatter_matrix.png")
plt.close()

# 4. Linear regression coefficients
plt.figure(figsize=(8, 6))
plt.bar(features, model.coef_)
plt.xlabel("Feature")
plt.ylabel("Coefficient Weight")
plt.title("Linear Regression Coefficients")
plt.xticks(rotation=45)
plt.tight_layout()
plt.savefig(f"{output_dir}/coefficients.png")
plt.close()

# 5. Histogram of features and target
plt.figure(figsize=(12, 8))
df[features + [target]].hist(bins=20, figsize=(12, 8))
plt.tight_layout()
plt.savefig(f"{output_dir}/feature_histograms.png")
plt.close()

# 6. Correlation heatmap
plt.figure(figsize=(10, 8))
corr = df[features + [target]].corr()
sns.heatmap(corr, annot=True, cmap='coolwarm', fmt=".2f")
plt.title("Correlation Heatmap")
plt.tight_layout()
plt.savefig(f"{output_dir}/correlation_heatmap.png")
plt.close()

# 7. Prediction error distribution
errors = y_test - y_pred
plt.figure(figsize=(8, 6))
sns.histplot(errors, kde=True, bins=30, color='purple')
plt.xlabel("Prediction Error")
plt.ylabel("Frequency")
plt.title("Prediction Error Distribution")
plt.tight_layout()
plt.savefig(f"{output_dir}/prediction_error_distribution.png")
plt.close()

# 8. Pairplot (regression lines)
sns.pairplot(df[features + [target]], kind='reg', diag_kind='kde')
plt.savefig(f"{output_dir}/pairplot.png")
plt.close()

# 9. Feature importance (absolute coefficients)
plt.figure(figsize=(8, 6))
coef_abs = np.abs(model.coef_)
plt.bar(features, coef_abs, color='green')
plt.xlabel("Feature")
plt.ylabel("Absolute Coefficient")
plt.title("Feature Importance by Coefficient Magnitude")
plt.xticks(rotation=45)
plt.tight_layout()
plt.savefig(f"{output_dir}/feature_importance.png")
plt.close()

# 10. Boxplot for each feature vs Price
for feature in features:
    plt.figure(figsize=(8, 6))
    sns.boxplot(x=pd.qcut(df[feature], q=5), y=df[target])
    plt.xlabel(feature)
    plt.ylabel("Price")
    plt.title(f"Price Distribution vs {feature}")
    plt.xticks(rotation=45)
    plt.tight_layout()
    plt.savefig(f"{output_dir}/boxplot_{feature.replace(' ', '_')}.png")
    plt.close()

# Save cleaned data
df.to_csv(f"{output_dir}/cleaned_house_data.csv", index=False)

print("Finished! All files saved in:", output_dir)
